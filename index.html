<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å½“ç›´æ±ºã‚ãƒ„ãƒ¼ãƒ«ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥å¯¾ç­–ç‰ˆï¼‰</title>
    <style>
        /* ã‚¹ãƒãƒ›ã§è¦‹ã‚„ã™ã„åŸºæœ¬è¨­å®š */
        body { 
            font-family: sans-serif; 
            margin: 0; 
            padding: 10px; 
            background: #f4f7f6; 
            color: #333;
            padding-bottom: 100px; /* ä¸‹éƒ¨ã®ä½™è£• */
        }

        /* ãƒ‘ãƒãƒ«ã®ãƒ‡ã‚¶ã‚¤ãƒ³ */
        .card { 
            background: #fff; 
            padding: 15px; 
            border-radius: 12px; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.1); 
            margin-bottom: 20px; 
        }

        h2 { 
            text-align: center; 
            margin: 0 0 15px 0; 
            font-size: 1.2rem; 
            color: #007bff; 
        }

        /* å…¥åŠ›ã‚¨ãƒªã‚¢ */
        label { display: block; font-weight: bold; margin-bottom: 5px; }
        
        /* ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠãƒœã‚¿ãƒ³ã‚’å¤§ãã */
        input[type="file"] {
            font-size: 16px;
            width: 100%;
            padding: 10px;
            background: #e9ecef;
            border-radius: 8px;
        }

        /* åå‰ãƒªã‚¹ãƒˆã‚¨ãƒªã‚¢ï¼ˆéš ã•ãšã«è¡¨ç¤ºï¼‰ */
        textarea { 
            width: 100%; 
            height: 80px; 
            padding: 10px; 
            border: 1px solid #ccc; 
            border-radius: 8px; 
            font-size: 16px; /* ã‚¹ãƒãƒ›ã§æ–‡å­—ãŒå°ã•ããªã‚‰ãªã„ã‚ˆã†ã« */
            box-sizing: border-box;
        }

        /* åå‰ãƒœã‚¿ãƒ³ã‚¨ãƒªã‚¢ */
        #nameButtons { 
            display: flex; 
            flex-wrap: wrap; 
            gap: 8px; 
            margin-top: 10px; 
            padding: 10px; 
            background: #f8f9fa; 
            border-radius: 8px;
        }
        
        .name-btn { 
            background: #fff; 
            border: 2px solid #ddd; 
            color: #333; 
            padding: 10px 14px; 
            border-radius: 20px; 
            font-size: 15px; 
            font-weight: bold;
            touch-action: manipulation; /* ã‚¿ãƒƒãƒ—ã®åå¿œã‚’è‰¯ãã™ã‚‹ */
        }
        .name-btn.active { 
            background: #d63384; 
            color: white; 
            border-color: #d63384; 
            box-shadow: 0 4px 6px rgba(214, 51, 132, 0.3);
            transform: scale(1.05); 
        }

        /* æ“ä½œãƒœã‚¿ãƒ³ */
        .btn-row { display: flex; gap: 10px; margin-top: 15px; }
        button.action-btn { 
            flex: 1; 
            padding: 12px; 
            border: none; 
            border-radius: 8px; 
            font-weight: bold; 
            color: white; 
            font-size: 14px;
        }
        .btn-gray { background: #6c757d; }
        .btn-blue { background: #007bff; }
        .btn-green { background: #28a745; }

        /* ç”»åƒè¡¨ç¤ºã‚¨ãƒªã‚¢ */
        .canvas-container {
            position: relative;
            background: #fff;
            border: 3px dashed #ccc;
            min-height: 250px;
            text-align: center;
            overflow: auto;
            border-radius: 8px;
        }
        canvas { 
            display: block; 
            margin: 0 auto; 
            max-width: 100%; 
            touch-action: none; /* ã‚­ãƒ£ãƒ³ãƒã‚¹ä¸Šã®æ¨™æº–ã‚¿ãƒƒãƒæ“ä½œã‚’ç„¡åŠ¹åŒ–ï¼ˆãƒ‰ãƒ©ãƒƒã‚°ç”¨ï¼‰ */
        }
        .placeholder-text {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            color: #aaa;
            font-weight: bold;
            pointer-events: none;
        }

        /* é¸æŠä¸­ã®åå‰è¡¨ç¤ºï¼ˆç”»é¢ä¸Šéƒ¨ã«å›ºå®šï¼‰ */
        #stickyBar {
            position: sticky;
            top: 0;
            left: 0;
            right: 0;
            background: rgba(255,255,255,0.95);
            padding: 10px;
            text-align: center;
            border-bottom: 2px solid #d63384;
            z-index: 1000;
            display: none;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>

    <div id="stickyBar">
        ã‚¹ã‚¿ãƒ³ãƒ—å¾…æ©Ÿä¸­ï¼š<span id="stickyName" style="color:#d63384; font-size:1.4em; font-weight:bold;">---</span>
    </div>

    <div class="card">
        <h2>ğŸ“ å½“ç›´æ±ºã‚ãƒ„ãƒ¼ãƒ«</h2>

        <div style="background:#e8f0fe; padding:10px; border-radius:8px; margin-bottom:15px;">
            <label>ğŸ”„ ãƒ‡ãƒ¼ã‚¿ã®å¼•ç¶™ã</label>
            <div class="btn-row" style="margin-top:5px;">
                <button class="action-btn btn-green" id="saveDataBtn">ä¿å­˜ (é€ã‚‹)</button>
                <button class="action-btn btn-green" onclick="document.getElementById('loadDataInput').click()">èª­è¾¼ (å—å–ã‚‹)</button>
            </div>
            <input type="file" id="loadDataInput" accept=".json" style="display:none">
        </div>

        <label>1. ç”»åƒã‚’é¸æŠ</label>
        <input type="file" id="imageInput" accept="image/*">
        
        <hr style="margin: 20px 0; border:0; border-top:1px solid #eee;">

        <label>2. åå‰ãƒªã‚¹ãƒˆ (ã“ã“ã‹ã‚‰ç·¨é›†å¯èƒ½)</label>
        <textarea id="nameList" oninput="updateButtons()">çŸ³äº•
å†¨æ²¢
æ ¹å²¸
ç”ºç”°
å±±å£
å±±æœ¬
æ¸¡é‚‰
å¤§äº•
ç«‹çŸ³
æ¯”å˜‰
å¹³é‡
æ‘å±±
å®ˆå±‹
è«¸å²¡</textarea>

        <label style="margin-top:10px;">ğŸ‘‡ åå‰ã‚’ã‚¿ãƒƒãƒ—ã—ã¦é¸æŠ</label>
        <div id="nameButtons"></div>

        <hr style="margin: 20px 0; border:0; border-top:1px solid #eee;">

        <label>3. æ–‡å­—ã‚µã‚¤ã‚ºè¨­å®š</label>
        <div style="display:flex; align-items:center; gap:10px;">
            <input type="number" id="fontSize" value="18" style="width:60px; padding:10px; font-size:16px;"> px
        </div>

        <div class="btn-row">
            <button class="action-btn btn-gray" id="undoBtn">1ã¤æˆ»ã‚‹</button>
            <button class="action-btn btn-blue" id="downloadBtn">ç”»åƒã‚’ä¿å­˜</button>
        </div>
    </div>

    <p style="text-align:center; color:#666; font-size:0.9rem;">
        ç”»åƒã®ä¸Šã‚’<b>ã‚¿ãƒƒãƒ—</b>ã§ã‚¹ã‚¿ãƒ³ãƒ—<br>
        ç½®ã„ãŸåå‰ã‚’<b>æŒ‡ã§ãªãã‚‹ã¨ç§»å‹•</b>
    </p>

    <div class="canvas-container">
        <div class="placeholder-text" id="placeholder">ã“ã“ã«ç”»åƒãŒè¡¨ç¤ºã•ã‚Œã¾ã™</div>
        <canvas id="myCanvas"></canvas>
    </div>

<script>
    // ã‚¨ãƒ©ãƒ¼å¯¾ç­–ï¼šå¤‰æ•°ã‚’ç¢ºå®Ÿã«å–å¾—
    const canvas = document.getElementById('myCanvas');
    const ctx = canvas.getContext('2d');
    const stickyBar = document.getElementById('stickyBar');
    const stickyName = document.getElementById('stickyName');
    const placeholder = document.getElementById('placeholder');
    
    let baseImg = new Image();
    let stamps = []; 
    let currentName = null;
    let imgLoaded = false;
    
    // ãƒ‰ãƒ©ãƒƒã‚°æ“ä½œç”¨
    let isDragging = false;
    let dragTargetIndex = -1;
    let startX = 0;
    let startY = 0;
    let touchStartTime = 0;

    // åˆæœŸåŒ–ï¼šãƒœã‚¿ãƒ³ã‚’ä½œã‚‹
    updateButtons();

    // 1. ç”»åƒèª­ã¿è¾¼ã¿ (ã‚¹ãƒãƒ›å¯¾å¿œå¼·åŒ–)
    document.getElementById('imageInput').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if(!file) return;

        placeholder.textContent = "ç”»åƒã‚’èª­ã¿è¾¼ã¿ä¸­...";

        const reader = new FileReader();
        reader.onload = function(event) {
            baseImg = new Image();
            baseImg.onload = function() {
                imgLoaded = true;
                stamps = []; // ãƒªã‚»ãƒƒãƒˆ
                fitCanvas(); // ã‚µã‚¤ã‚ºèª¿æ•´
                redraw();
                placeholder.style.display = 'none'; // æ–‡å­—ã‚’æ¶ˆã™
                alert("ç”»åƒãŒå…¥ã‚Šã¾ã—ãŸï¼ä¸‹ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã—ã¦ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
            }
            baseImg.onerror = function() {
                alert("ç”»åƒã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚åˆ¥ã®ç”»åƒã‚’è©¦ã—ã¦ãã ã•ã„ã€‚");
            }
            baseImg.src = event.target.result;
        }
        reader.readAsDataURL(file);
    });

    // ç”»é¢å¹…ã«åˆã‚ã›ã¦ãƒªã‚µã‚¤ã‚ºï¼ˆãƒ¡ãƒ¢ãƒªä¸è¶³å¯¾ç­–ï¼‰
    function fitCanvas() {
        if(!imgLoaded) return;
        let w = baseImg.width;
        let h = baseImg.height;
        
        // ã‚¹ãƒãƒ›å‘ã‘ã«æœ€å¤§å¹…ã‚’1500pxã«åˆ¶é™ï¼ˆã“ã‚Œä»¥ä¸Šã ã¨è½ã¡ã‚‹å¯èƒ½æ€§ã‚ã‚Šï¼‰
        const MAX_W = 1500;
        if(w > MAX_W) {
            h = Math.round(h * (MAX_W / w));
            w = MAX_W;
        }
        canvas.width = w;
        canvas.height = h;
    }

    // 2. æç”»å‡¦ç†
    function redraw() {
        if (!imgLoaded) return;
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.drawImage(baseImg, 0, 0, canvas.width, canvas.height);

        const fontSize = parseInt(document.getElementById('fontSize').value) || 18;
        ctx.font = `bold ${fontSize}px sans-serif`;
        ctx.textBaseline = "middle";
        ctx.textAlign = "center";

        stamps.forEach(stamp => {
            const metrics = ctx.measureText(stamp.name);
            const w = metrics.width + 10;
            const h = fontSize + 10;
            stamp.w = w;
            stamp.h = h;

            // ç™½èƒŒæ™¯
            ctx.fillStyle = "rgba(255, 255, 255, 0.9)";
            ctx.fillRect(stamp.x - w/2, stamp.y - h/2, w, h);
            
            // æ–‡å­—
            ctx.fillStyle = "black";
            ctx.fillText(stamp.name, stamp.x, stamp.y);
        });
    }

    // 3. åå‰ãƒœã‚¿ãƒ³ç”Ÿæˆ
    function updateButtons() {
        const listArea = document.getElementById('nameButtons');
        const textVal = document.getElementById('nameList').value;
        listArea.innerHTML = "";
        
        if (!textVal) return; // ç©ºãªã‚‰ä½•ã‚‚ã—ãªã„

        const names = textVal.split('\n');
        names.forEach(name => {
            if(!name.trim()) return;
            const btn = document.createElement('div'); // divã«å¤‰æ›´ã—ã¦ã‚¹ã‚¿ã‚¤ãƒ«èª¿æ•´ã—ã‚„ã™ã
            btn.className = "name-btn";
            btn.textContent = name;
            btn.onclick = () => {
                currentName = name;
                stickyName.textContent = name;
                stickyBar.style.display = 'block';
                // è‰²å¤‰ãˆ
                document.querySelectorAll('.name-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
            };
            listArea.appendChild(btn);
        });
    }

    // 4. ã‚¿ãƒƒãƒæ“ä½œ (Pointer Events)
    canvas.addEventListener('pointerdown', function(e) {
        if (!imgLoaded) return;
        const pos = getPos(e);
        const hitIndex = getHitStampIndex(pos.x, pos.y);

        if (hitIndex !== -1) {
            isDragging = true;
            dragTargetIndex = hitIndex;
            canvas.setPointerCapture(e.pointerId);
            e.preventDefault();
        } else {
            touchStartTime = Date.now();
            startX = e.clientX;
            startY = e.clientY;
        }
    });

    canvas.addEventListener('pointermove', function(e) {
        if (isDragging && dragTargetIndex !== -1) {
            e.preventDefault();
            const pos = getPos(e);
            stamps[dragTargetIndex].x = pos.x;
            stamps[dragTargetIndex].y = pos.y;
            redraw();
        }
    });

    canvas.addEventListener('pointerup', function(e) {
        if (isDragging) {
            isDragging = false;
            dragTargetIndex = -1;
            canvas.releasePointerCapture(e.pointerId);
        } else {
            // ã‚¿ãƒƒãƒ—åˆ¤å®š
            const dist = Math.hypot(e.clientX - startX, e.clientY - startY);
            if (dist < 10 && (Date.now() - touchStartTime) < 500) {
                if (!currentName) {
                    alert("â†‘ å…ˆã«ãƒªã‚¹ãƒˆã‹ã‚‰åå‰ã‚’é¸ã‚“ã§ãã ã•ã„");
                    window.scrollTo({top: 0, behavior: 'smooth'});
                    return;
                }
                const pos = getPos(e);
                stamps.push({ x: pos.x, y: pos.y, name: currentName });
                redraw();
            }
        }
    });

    function getPos(e) {
        const rect = canvas.getBoundingClientRect();
        const scaleX = canvas.width / rect.width;
        const scaleY = canvas.height / rect.height;
        return {
            x: (e.clientX - rect.left) * scaleX,
            y: (e.clientY - rect.top) * scaleY
        };
    }

    function getHitStampIndex(x, y) {
        for (let i = stamps.length - 1; i >= 0; i--) {
            const s = stamps[i];
            // æŒ‡ã§ã®æ“ä½œãªã®ã§åˆ¤å®šã‚¨ãƒªã‚¢ã‚’å°‘ã—åºƒã‚(1.2å€)ã«ã¨ã‚‹
            if (x >= s.x - (s.w*1.2)/2 && x <= s.x + (s.w*1.2)/2 &&
                y >= s.y - (s.h*1.2)/2 && y <= s.y + (s.h*1.2)/2) {
                return i;
            }
        }
        return -1;
    }

    // ä¿å­˜ãƒ»æˆ»ã‚‹æ©Ÿèƒ½
    document.getElementById('undoBtn').addEventListener('click', () => {
        if(stamps.length > 0) { stamps.pop(); redraw(); }
    });
    
    document.getElementById('downloadBtn').addEventListener('click', () => {
        if(!imgLoaded) return;
        const link = document.createElement('a');
        link.download = 'roster_complete.png';
        link.href = canvas.toDataURL();
        link.click();
    });

    // ãƒ‡ãƒ¼ã‚¿å¼•ç¶™ã
    document.getElementById('saveDataBtn').addEventListener('click', () => {
        if(!imgLoaded) { alert("ç”»åƒãŒã‚ã‚Šã¾ã›ã‚“"); return; }
        const data = { imageSrc: baseImg.src, stamps: stamps };
        const blob = new Blob([JSON.stringify(data)], {type: "application/json"});
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = "data.json";
        link.click();
    });

    document.getElementById('loadDataInput').addEventListener('change', (e) => {
        const file = e.target.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = (event) => {
            try {
                const data = JSON.parse(event.target.result);
                baseImg = new Image();
                baseImg.onload = () => {
                    imgLoaded = true;
                    stamps = data.stamps || [];
                    fitCanvas();
                    redraw();
                    placeholder.style.display = 'none';
                    alert("ç¶šãã‹ã‚‰ç·¨é›†ã§ãã¾ã™ï¼");
                };
                baseImg.src = data.imageSrc;
            } catch(err) { alert("èª­è¾¼ã‚¨ãƒ©ãƒ¼"); }
        };
        reader.readAsText(file);
    });

</script>
</body>
</html>