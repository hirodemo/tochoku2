<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å½“ç›´æ±ºã‚ãƒ„ãƒ¼ãƒ«ï¼ˆã‚ºãƒ¼ãƒ å¯¾å¿œç‰ˆï¼‰</title>
    <style>
        body { font-family: sans-serif; max-width: 900px; margin: 0 auto; padding: 10px; background: #f0f2f5; padding-bottom: 100px; touch-action: pan-x pan-y; }
        .controls { background: #fff; padding: 15px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 20px; }
        h2 { margin-top: 0; font-size: 1.3rem; text-align: center; color: #007bff; }
        label { font-weight: bold; display: block; margin-bottom: 8px; font-size: 0.95rem; }
        
        /* ãƒœã‚¿ãƒ³é¡ */
        .btn { padding: 12px; border: none; border-radius: 8px; font-weight: bold; color: white; font-size: 14px; cursor: pointer; width: 100%; margin-bottom: 10px; }
        .btn-blue { background: #007bff; } .btn-green { background: #28a745; } .btn-gray { background: #6c757d; }
        .btn-row { display: flex; gap: 10px; } .btn-row .btn { margin-bottom: 0; }

        /* åå‰ãƒœã‚¿ãƒ³ */
        #nameButtons { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 8px; }
        .name-btn { background: #fff; border: 2px solid #ddd; color: #333; padding: 10px 14px; border-radius: 20px; font-size: 15px; font-weight: bold; touch-action: manipulation; }
        .name-btn.active { background: #d63384; color: white; border-color: #d63384; transform: scale(1.05); box-shadow: 0 4px 6px rgba(214, 51, 132, 0.3); }

        /* ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚¨ãƒªã‚¢ */
        .canvas-container {
            position: relative;
            width: 100%;
            height: 60vh; /* ç”»é¢ã®é«˜ã•ã®60% */
            border: 3px solid #ccc;
            background: #e9ecef;
            overflow: hidden; /* ã¯ã¿å‡ºãŸéƒ¨åˆ†ã‚’éš ã™ */
            border-radius: 8px;
            touch-action: none; /* ãƒ–ãƒ©ã‚¦ã‚¶æ¨™æº–ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãªã©ã‚’ç„¡åŠ¹åŒ– */
        }
        canvas { 
            display: block; 
            /* ã‚­ãƒ£ãƒ³ãƒã‚¹è‡ªä½“ã¯ä¸­å¤®å¯„ã›ã—ãªã„ï¼ˆJSã§ä½ç½®åˆ¶å¾¡ã™ã‚‹ãŸã‚ï¼‰ */
            transform-origin: 0 0; /* å¤‰å½¢ã®åŸºæº–ã‚’å·¦ä¸Šã« */
        }
        .placeholder-text {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            color: #888; font-weight: bold; pointer-events: none;
        }
        
        /* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒ¼ */
        #stickyBar {
            position: sticky; top: 0; left: 0; right: 0; z-index: 1000;
            background: rgba(255,255,255,0.95); padding: 10px; text-align: center;
            border-bottom: 2px solid #d63384; display: none; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>

    <div id="stickyBar">
        ã‚¹ã‚¿ãƒ³ãƒ—å¾…æ©Ÿä¸­ï¼š<span id="stickyName" style="color:#d63384; font-size:1.4em; font-weight:bold;">---</span>
    </div>

    <div class="controls">
        <h2>ğŸ“ å½“ç›´æ±ºã‚ãƒ„ãƒ¼ãƒ«ï¼ˆã‚ºãƒ¼ãƒ å¯¾å¿œï¼‰</h2>

        <div style="background:#e8f0fe; padding:12px; border-radius:8px; margin-bottom:20px; border:1px dashed #007bff;">
            <label style="color:#007bff;">ğŸ”„ ãƒ‡ãƒ¼ã‚¿ã®å¼•ç¶™ã (ãƒãƒ¼ãƒ é€£æº)</label>
            <div class="btn-row">
                <button class="btn btn-green" id="saveDataBtn">ğŸ“¤ ä¿å­˜ (é€ã‚‹)</button>
                <button class="btn btn-green" onclick="document.getElementById('loadDataInput').click()">ğŸ“¥ èª­è¾¼ (å—å–ã‚‹)</button>
            </div>
            <input type="file" id="loadDataInput" accept=".json" style="display:none">
        </div>

        <label>1. ç”»åƒã‚’é¸æŠ</label>
        <input type="file" id="imageInput" accept="image/*" style="font-size:16px; width:100%; padding:10px; background:#e9ecef; border-radius:8px;">
        
        <hr style="margin: 20px 0; border:0; border-top:1px solid #eee;">

        <label>2. åå‰ãƒªã‚¹ãƒˆ (ç·¨é›†å¯èƒ½)</label>
        <textarea id="nameList" oninput="updateButtons()" style="width:100%; height:100px; padding:10px; border:1px solid #ccc; border-radius:8px; font-size:16px; box-sizing:border-box;">çŸ³äº•
å†¨æ²¢
æ ¹å²¸
ç”ºç”°
å±±å£
å±±æœ¬
æ¸¡é‚‰
å¤§äº•
ç«‹çŸ³
æ¯”å˜‰
å¹³é‡
æ‘å±±
å®ˆå±‹
è«¸å²¡</textarea>

        <label style="margin-top:10px;">ğŸ‘‡ åå‰ã‚’ã‚¿ãƒƒãƒ—ã—ã¦é¸æŠ</label>
        <div id="nameButtons"></div>

        <hr style="margin: 20px 0; border:0; border-top:1px solid #eee;">

        <label>3. è¨­å®šãƒ»ä¿å­˜</label>
        <div style="display:flex; align-items:center; gap:15px; margin-bottom:15px;">
            <span>æ–‡å­—ã‚µã‚¤ã‚º:</span>
            <input type="number" id="fontSize" value="24" style="width:70px; padding:10px; font-size:16px; border:1px solid #ccc; border-radius:8px;"> px
        </div>

        <div class="btn-row">
            <button class="btn btn-gray" id="undoBtn">â†© 1ã¤æˆ»ã‚‹</button>
            <button class="btn btn-blue" id="downloadBtn">ğŸ“· ç”»åƒã‚’ä¿å­˜</button>
        </div>
    </div>

    <p style="text-align:center; color:#666; font-size:0.9rem; margin-bottom:5px;">
        <b>2æœ¬æŒ‡ã§æ‹¡å¤§ãƒ»ç¸®å°</b>ã€<b>1æœ¬æŒ‡ã§ç§»å‹•</b><br>
        è»½ã<b>ã‚¿ãƒƒãƒ—</b>ã§ã‚¹ã‚¿ãƒ³ãƒ—ã€åå‰ã‚’<b>é•·æŠ¼ã—ãƒ‰ãƒ©ãƒƒã‚°</b>ã§ç§»å‹•
    </p>

    <div class="canvas-container" id="canvasContainer">
        <div class="placeholder-text" id="placeholder">ã“ã“ã«ç”»åƒãŒè¡¨ç¤ºã•ã‚Œã¾ã™</div>
        <canvas id="myCanvas"></canvas>
    </div>

<script>
    const canvas = document.getElementById('myCanvas');
    const ctx = canvas.getContext('2d');
    const container = document.getElementById('canvasContainer');
    const stickyBar = document.getElementById('stickyBar');
    const stickyName = document.getElementById('stickyName');
    const placeholder = document.getElementById('placeholder');
    
    // ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«
    let baseImg = new Image();
    let stamps = []; 
    let currentName = null;
    let imgLoaded = false;

    // ãƒ“ãƒ¥ãƒ¼ï¼ˆè¡¨ç¤ºï¼‰ã®çŠ¶æ…‹ç®¡ç†
    let scale = 1.0;
    let originX = 0;
    let originY = 0;
    const MIN_SCALE = 0.5;
    const MAX_SCALE = 5.0;
    
    // æ“ä½œç”¨å¤‰æ•°
    let isDraggingItem = false;
    let dragTargetIndex = -1;
    let isPanning = false;
    let lastPanX = 0, lastPanY = 0;
    let touchStartTime = 0;
    let startTapX = 0, startTapY = 0;
    let initialPinchDistance = 0;
    let initialScale = 1.0;
    
    // ãƒã‚¤ãƒ³ã‚¿ãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆã®è¿½è·¡ç”¨
    let activePointers = new Map();

    updateButtons();

    // 1. ç”»åƒèª­ã¿è¾¼ã¿
    document.getElementById('imageInput').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if(!file) return;
        placeholder.textContent = "ç”»åƒã‚’èª­ã¿è¾¼ã¿ä¸­...";
        const reader = new FileReader();
        reader.onload = function(event) {
            baseImg = new Image();
            baseImg.onload = function() {
                imgLoaded = true;
                stamps = [];
                // åˆæœŸè¡¨ç¤ºä½ç½®ã‚’ãƒªã‚»ãƒƒãƒˆ
                scale = 1.0; originX = 0; originY = 0;
                canvas.width = baseImg.width;
                canvas.height = baseImg.height;
                // åˆæœŸè¡¨ç¤ºã§ä¸­å¤®ã«åˆã‚ã›ã‚‹é–¢æ•°ã‚’å‘¼ã¶
                resetView();
                redraw();
                placeholder.style.display = 'none';
            }
            baseImg.src = event.target.result;
        }
        reader.readAsDataURL(file);
    });

    // 2. æç”»å‡¦ç†ï¼ˆã‚ºãƒ¼ãƒ ãƒ»ãƒ‘ãƒ³å¯¾å¿œï¼‰
    function redraw() {
        if (!imgLoaded) return;
        
        // ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚’ã‚¯ãƒªã‚¢ï¼ˆå¤‰æ›è¡Œåˆ—ã‚‚ãƒªã‚»ãƒƒãƒˆï¼‰
        ctx.setTransform(1, 0, 0, 1, 0, 0);
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        // ç¾åœ¨ã®ã‚ºãƒ¼ãƒ ã¨ä½ç½®ã‚’é©ç”¨ã—ã¦æç”»é–‹å§‹
        ctx.setTransform(scale, 0, 0, scale, originX, originY);

        // ç”»åƒã‚’æç”»
        ctx.drawImage(baseImg, 0, 0);

        // ã‚¹ã‚¿ãƒ³ãƒ—ã‚’æç”»
        const fontSize = parseInt(document.getElementById('fontSize').value) || 24;
        ctx.font = `bold ${fontSize}px sans-serif`;
        ctx.textBaseline = "middle";
        ctx.textAlign = "center";

        stamps.forEach(stamp => {
            const metrics = ctx.measureText(stamp.name);
            const w = metrics.width + 14;
            const h = fontSize + 14;
            stamp.w = w; stamp.h = h; // ãƒ’ãƒƒãƒˆåˆ¤å®šç”¨ã«ä¿å­˜

            ctx.fillStyle = "rgba(255, 255, 255, 0.95)";
            ctx.shadowColor = "rgba(0,0,0,0.2)";
            ctx.shadowBlur =