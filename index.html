<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å½“ç›´æ±ºã‚ãƒ„ãƒ¼ãƒ«</title>
    <style>
        body { font-family: sans-serif; max-width: 900px; margin: 0 auto; padding: 10px; background: #f0f2f5; padding-bottom: 80px;}
        .controls { background: #fff; padding: 15px; border-radius: 8px; border: 1px solid #ccc; margin-bottom: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        
        h2 { margin-top: 0; font-size: 1.2rem; text-align: center; color: #444; }
        label { font-weight: bold; display: block; margin-bottom: 5px; font-size: 0.9rem; }
        
        /* ãƒœã‚¿ãƒ³é¡ */
        button { padding: 10px 14px; cursor: pointer; border: none; border-radius: 4px; font-weight: bold; font-size: 14px; margin: 3px; }
        .btn-blue { background: #007bff; color: white; }
        .btn-green { background: #28a745; color: white; }
        .btn-gray { background: #6c757d; color: white; }
        
        /* åå‰ãƒœã‚¿ãƒ³ */
        #nameButtons { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 5px; }
        .name-btn { background: #fff; border: 1px solid #ccc; color: #333; padding: 10px 12px; border-radius: 4px; font-size: 15px; touch-action: manipulation;}
        .name-btn.active { background: #d63384; color: white; border-color: #d63384; transform: scale(1.05); box-shadow: 0 2px 5px rgba(0,0,0,0.2); }

        /* ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚¨ãƒªã‚¢ */
        .canvas-wrapper {
            position: relative;
            width: 100%;
            overflow: auto; 
            border: 2px solid #aaa;
            background: #fff;
            min-height: 300px;
            text-align: center;
            overscroll-behavior: none; 
        }
        canvas { 
            display: block; 
            margin: 0 auto; 
            max-width: 100%; 
            touch-action: none; 
        }

        /* å¼•ç¶™ãã‚¨ãƒªã‚¢ */
        .relay-area { background: #e8f0fe; padding: 12px; border-radius: 6px; border: 1px dashed #007bff; margin-bottom: 15px; }
        
        /* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒ¼ */
        .status-bar {
            position: sticky; top: 0; z-index: 100;
            background: rgba(255,255,255,0.95);
            padding: 8px; border-bottom: 2px solid #d63384;
            text-align: center; font-weight: bold;
            display: none; 
        }
    </style>
</head>
<body>

    <div id="stickyStatus" class="status-bar">
        ã‚¹ã‚¿ãƒ³ãƒ—å¾…æ©Ÿä¸­ï¼š<span id="stickyName" style="color:#d63384; font-size:1.2em;">---</span>
    </div>

    <div class="controls">
        <h2>ğŸ“ å½“ç›´æ±ºã‚ãƒ„ãƒ¼ãƒ«</h2>

        <div class="relay-area">
            <label>ğŸ”„ ãƒãƒ¼ãƒ é€£æºï¼ˆãƒ‡ãƒ¼ã‚¿é€å—ä¿¡ï¼‰</label>
            <button class="btn-green" id="saveDataBtn">ğŸ“¤ ä½œæ¥­ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ (é€ã‚‹)</button>
            <button class="btn-green" onclick="document.getElementById('loadDataInput').click()">ğŸ“¥ ãƒ‡ãƒ¼ã‚¿èª­è¾¼ (å—å–ã‚‹)</button>
            <input type="file" id="loadDataInput" accept=".json" style="display:none">
            <p style="font-size:11px; margin:5px 0 0; color:#555;">â€»ä½œæ¥­çŠ¶æ…‹ã‚’ä¿å­˜ã—ã¦ã€LINEç­‰ã§æ¬¡ã®äººã«é€ã‚Œã¾ã™ã€‚</p>
        </div>

        <label>1. ç”»åƒã‚’é¸æŠ</label>
        <input type="file" id="imageInput" accept="image/*">
        
        <hr style="margin: 15px 0; border:0; border-top:1px solid #eee;">

        <label>2. åå‰ã‚’é¸æŠ</label>
        <textarea id="nameList" style="display:none;">çŸ³äº•
å†¨æ²¢
æ ¹å²¸
ç”ºç”°
å±±å£
å±±æœ¬
æ¸¡é‚‰
å¤§äº•
ç«‹çŸ³
æ¯”å˜‰
å¹³é‡
æ‘å±±
å®ˆå±‹
è«¸å²¡</textarea>
        
        <div id="nameButtons"></div>

        <hr style="margin: 15px 0; border:0; border-top:1px solid #eee;">

        <label>3. è¨­å®šãƒ»ä¿å­˜</label>
        <div>
            <label style="display:inline-block; margin-right:10px;">ã‚µã‚¤ã‚º: <input type="number" id="fontSize" value="18" style="width:50px"> px</label>
            <button id="undoBtn" class="btn-gray">â†© 1ã¤æˆ»ã‚‹</button>
            <button id="clearBtn" class="btn-gray" style="background:#dc3545;">ğŸ—‘ å…¨æ¶ˆå»</button>
        </div>
        <div style="margin-top:10px;">
            <button id="downloadBtn" class="btn-blue" style="width:100%; padding:12px;">ğŸ“· ç”»åƒã¨ã—ã¦å®Œæˆä¿å­˜</button>
        </div>
    </div>

    <p style="text-align:center; font-size:0.8rem; color:#666;">ğŸ‘‡ <b>ç©ºãåœ°ã‚’ã‚¿ãƒƒãƒ—</b>ã§ã‚¹ã‚¿ãƒ³ãƒ—ã€<b>åå‰ã‚’ãƒ‰ãƒ©ãƒƒã‚°</b>ã§ç§»å‹•</p>
    <div class="canvas-wrapper" id="canvasWrapper">
        <canvas id="myCanvas"></canvas>
    </div>

<script>
    const canvas = document.getElementById('myCanvas');
    const ctx = canvas.getContext('2d');
    const stickyStatus = document.getElementById('stickyStatus');
    
    let baseImg = new Image();
    let stamps = []; 
    let currentName = null;
    let imgLoaded = false;
    
    // ãƒ‰ãƒ©ãƒƒã‚°ç”¨å¤‰æ•°
    let isDragging = false;
    let dragTargetIndex = -1;
    let startX = 0;
    let startY = 0;
    let touchStartTime = 0;

    // åˆæœŸåŒ–
    updateButtons();

    // 1. ç”»åƒèª­ã¿è¾¼ã¿
    document.getElementById('imageInput').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = function(event) {
            baseImg = new Image();
            baseImg.onload = function() {
                imgLoaded = true;
                stamps = []; 
                fitCanvas();
                redraw();
            }
            baseImg.src = event.target.result;
        }
        reader.readAsDataURL(file);
    });

    function fitCanvas() {
        if(!imgLoaded) return;
        let w = baseImg.width;
        let h = baseImg.height;
        const MAX_W = 2000;
        if(w > MAX_W) {
            h = Math.round(h * (MAX_W / w));
            w = MAX_W;
        }
        canvas.width = w;
        canvas.height = h;
    }

    // 2. æç”»å‡¦ç†
    function redraw() {
        if (!imgLoaded) return;

        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.drawImage(baseImg, 0, 0, canvas.width, canvas.height);

        const fontSize = parseInt(document.getElementById('fontSize').value);
        ctx.font = `bold ${fontSize}px sans-serif`;
        ctx.textBaseline = "middle";
        ctx.textAlign = "center";

        stamps.forEach(stamp => {
            const metrics = ctx.measureText(stamp.name);
            const w = metrics.width + 10; 
            const h = fontSize + 10;
            stamp.w = w;
            stamp.h = h;

            ctx.fillStyle = "rgba(255, 255, 255, 0.9)";
            ctx.shadowColor = "rgba(0,0,0,0.3)";
            ctx.shadowBlur = 4;
            ctx.fillRect(stamp.x - w/2, stamp.y - h/2, w, h);
            ctx.shadowBlur = 0;

            ctx.fillStyle = "black";
            ctx.fillText(stamp.name, stamp.x, stamp.y);
        });
    }

    // 3. ã‚¿ãƒƒãƒï¼†ãƒ‰ãƒ©ãƒƒã‚°åˆ¶å¾¡
    canvas.addEventListener('pointerdown', function(e) {
        if (!imgLoaded) return;
        
        const pos = getPos(e);
        const hitIndex = getHitStampIndex(pos.x, pos.y);

        if (hitIndex !== -1) {
            isDragging = true;
            dragTargetIndex = hitIndex;
            canvas.setPointerCapture(e.pointerId);
            e.preventDefault(); 
        } else {
            touchStartTime = Date.now();
            startX = e.clientX;
            startY = e.clientY;
        }
    });

    canvas.addEventListener('pointermove', function(e) {
        if (isDragging && dragTargetIndex !== -1) {
            e.preventDefault();
            const pos = getPos(e);
            stamps[dragTargetIndex].x = pos.x;
            stamps[dragTargetIndex].y = pos.y;
            redraw();
        }
    });

    canvas.addEventListener('pointerup', function(e) {
        if (isDragging) {
            isDragging = false;
            dragTargetIndex = -1;
            canvas.releasePointerCapture(e.pointerId);
        } else {
            const dist = Math.hypot(e.clientX - startX, e.clientY - startY);
            const timeDiff = Date.now() - touchStartTime;

            if (dist < 10 && timeDiff < 500) {
                if (!currentName) {
                    alert("åå‰ã‚’é¸ã‚“ã§ãã ã•ã„");
                    document.querySelector('.controls').scrollIntoView({behavior:'smooth'});
                    return;
                }
                const pos = getPos(e);
                stamps.push({ x: pos.x, y: pos.y, name: currentName });
                redraw();
            }
        }
    });

    function getPos(e) {
        const rect = canvas.getBoundingClientRect();
        const scaleX = canvas.width / rect.width;
        const scaleY = canvas.height / rect.height;
        return {
            x: (e.clientX - rect.left) * scaleX,
            y: (e.clientY - rect.top) * scaleY
        };
    }

    function getHitStampIndex(x, y) {
        for (let i = stamps.length - 1; i >= 0; i--) {
            const s = stamps[i];
            if (x >= s.x - s.w/2 && x <= s.x + s.w/2 &&
                y >= s.y - s.h/2 && y <= s.y + s.h/2) {
                return i;
            }
        }
        return -1;
    }

    // 4. ãƒœã‚¿ãƒ³åˆ¶å¾¡
    function updateButtons() {
        const listArea = document.getElementById('nameButtons');
        listArea.innerHTML = "";
        const names = document.getElementById('nameList').value.split('\n');
        
        names.forEach(name => {
            if(!name.trim()) return;
            const btn = document.createElement('button');
            btn.className = "name-btn";
            btn.textContent = name;
            btn.onclick = () => {
                currentName = name;
                document.getElementById('stickyName').textContent = name;
                stickyStatus.style.display = 'block';
                document.querySelectorAll('.name-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
            };
            listArea.appendChild(btn);
        });
    }

    document.getElementById('undoBtn').addEventListener('click', () => {
        if(stamps.length > 0) { stamps.pop(); redraw(); }
    });
    
    document.getElementById('clearBtn').addEventListener('click', () => {
        if(confirm("é…ç½®ã—ãŸã‚¹ã‚¿ãƒ³ãƒ—ã‚’å…¨ã¦æ¶ˆã—ã¾ã™ã‹ï¼Ÿ")) { stamps = []; redraw(); }
    });

    document.getElementById('downloadBtn').addEventListener('click', () => {
        if(!imgLoaded) return;
        const link = document.createElement('a');
        link.download = 'roster_complete.png';
        link.href = canvas.toDataURL();
        link.click();
    });

    // ãƒ‡ãƒ¼ã‚¿å¼•ç¶™ãæ©Ÿèƒ½
    document.getElementById('saveDataBtn').addEventListener('click', () => {
        if(!imgLoaded) { alert("ä¿å­˜ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“"); return; }
        const data = { imageSrc: baseImg.src, stamps: stamps };
        const blob = new Blob([JSON.stringify(data)], {type: "application/json"});
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = "roster_data_" + new Date().getHours() + new Date().getMinutes() + ".json";
        link.click();
        alert("ä½œæ¥­ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚\nã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¬¡ã®äººã«é€ã£ã¦ãã ã•ã„ã€‚");
    });

    document.getElementById('loadDataInput').addEventListener('change', (e) => {
        const file = e.target.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = (event) => {
            try {
                const data = JSON.parse(event.target.result);
                baseImg = new Image();
                baseImg.onload = () => {
                    imgLoaded = true;
                    stamps = data.stamps || [];
                    fitCanvas();
                    redraw();
                    alert("ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒã—ã¾ã—ãŸï¼");
                };
                baseImg.src = data.imageSrc;
            } catch(err) { alert("ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å¤±æ•—"); }
        };
        reader.readAsText(file);
    });
</script>
</body>
</html>